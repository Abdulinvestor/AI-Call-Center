<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Call Center Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    h1 {
      color: #fff;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      font-size: 2.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-card h2 {
      margin: 0;
      color: #4f46e5;
      font-size: 2.5em;
      font-weight: 700;
    }

    .stat-card p {
      margin: 10px 0 0 0;
      color: #666;
      font-weight: 500;
    }

    .control-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn:hover {
      background: #3730a3;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    }

    .btn-success {
      background: #059669;
    }

    .btn-success:hover {
      background: #047857;
    }

    .btn-warning {
      background: #d97706;
    }

    .btn-warning:hover {
      background: #b45309;
    }

    .table-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      animation: fadeIn 1s ease;
    }

    thead {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
    }

    th,
    td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    tbody tr {
      transition: all 0.3s ease;
    }

    tbody tr:hover {
      background-color: #f8fafc;
      transform: scale(1.005);
    }

    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    .phone-number {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-weight: bold;
      color: #4f46e5;
      background: #eef2ff;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
      font-size: 12px;
    }

    .name-cell {
      font-weight: 600;
      color: #374151;
      max-width: 120px;
    }

    .age-cell {
      color: #8b5cf6;
      font-weight: 600;
      font-size: 14px;
    }

    .email-cell {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      color: #059669;
      font-size: 12px;
      max-width: 150px;
      word-break: break-all;
    }

    .location-cell {
      color: #d97706;
      font-weight: 500;
      max-width: 120px;
    }

    .introduction-cell {
      color: #6b7280;
      font-size: 13px;
      line-height: 1.4;
      max-width: 200px;
      word-wrap: break-word;
    }

    .timestamp {
      color: #9ca3af;
      font-size: 11px;
      font-family: monospace;
      max-width: 120px;
    }

    .loading,
    .error,
    .no-data {
      text-align: center;
      padding: 40px;
      font-size: 16px;
    }

    .loading {
      color: #6b7280;
      font-style: italic;
    }

    .error {
      color: #dc2626;
      font-weight: bold;
    }

    .no-data {
      color: #6b7280;
      font-style: italic;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: #10b981;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .loading-animation {
      animation: pulse 1.5s infinite;
    }

    input[type="date"] {
      appearance: none;
      -webkit-appearance: none;
      background: #4f46e5;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="date"]:hover {
      background: #3730a3;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    }

    /* Responsive design */
    @media (max-width: 1200px) {
      .container {
        max-width: 100%;
      }

      table {
        font-size: 12px;
      }

      th,
      td {
        padding: 10px 8px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      th,
      td {
        padding: 8px 6px;
        font-size: 11px;
      }

      .phone-number {
        font-size: 10px;
        padding: 3px 6px;
      }

      .control-buttons {
        flex-direction: column;
        align-items: center;
      }

      .table-container {
        overflow-x: auto;
      }

      /* Stack table data vertically on mobile */
      .name-cell,
      .email-cell,
      .age-cell,
      .location-cell,
      .introduction-cell {
        max-width: 100px;
        font-size: 10px;
      }
    }

    /* Tooltip for truncated text */
    .truncated {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: help;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üß† AI Call Center Dashboard</h1>

    <div class="control-buttons">
      <input type="date" id="datePicker" onchange="loadLogsByDate()" max="" />
      <button class="btn btn-success" onclick="makeTestCall()">üìû Make Test Call</button>
      <button class="btn" onclick="loadLogs()">üîÑ Refresh Data</button>
      <a href="/logs-view" target="_blank" class="btn btn-warning">üìä View Raw JSON</a>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h2 id="totalCalls">-</h2>
        <p>üìû Total Calls Processed</p>
      </div>
      <div class="stat-card">
        <h2 id="serverStatus">-</h2>
        <p><span class="status-indicator"></span>Server Status</p>
      </div>
      <div class="stat-card">
        <h2 id="lastCallTime">-</h2>
        <p>üïí Last Call</p>
      </div>
      <div class="stat-card">
        <h2 id="completedProfiles">-</h2>
        <p>‚úÖ Complete Profiles</p>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>üì± Phone</th>
            <th>üë§ Name</th>
            <th>üìß Email</th>
            <th>üéÇ Age</th>
            <th>üìç Location</th>
            <th>üí≠ Introduction</th>
            <th>‚è∞ Date & Time</th>
          </tr>
        </thead>
        <tbody id="logData">
          <tr>
            <td colspan="7" class="loading loading-animation">Loading call logs...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

 <script>
  const BASE_URL = 'http://localhost:5500';
  let allCalls = [];
  let refreshInterval;

  function loadLogs() {
    fetch(BASE_URL + "/logs")
      .then(res => res.json())
      .then(data => {
        allCalls = data.calls || [];
        document.getElementById("totalCalls").textContent = allCalls.length;
        document.getElementById("serverStatus").textContent = "Online";
        document.getElementById("lastCallTime").textContent = allCalls.length ? formatTimeAgo(allCalls[allCalls.length - 1].time) : 'No calls yet';

        const completeProfiles = allCalls.filter(call =>
          call.name && call.email && call.age && call.location && call.introduction
        ).length;
        document.getElementById("completedProfiles").textContent = completeProfiles;

        loadLogsByDate();
      })
      .catch(err => {
        console.error("Failed to fetch logs:", err);
        document.getElementById("serverStatus").textContent = "Offline";
        const logData = document.getElementById("logData");
        logData.innerHTML = `<tr><td colspan='7' class='error'>‚ùå Failed to connect to server</td></tr>`;
      });
  }

  function loadLogsByDate() {
    const selectedDate = document.getElementById("datePicker").value;
    const logData = document.getElementById("logData");
    logData.innerHTML = '';

    const filtered = selectedDate
      ? allCalls.filter(log => {
          const logDate = new Date(log.time).toISOString().split('T')[0];
          return logDate === selectedDate;
        })
      : allCalls;

    if (filtered.length === 0) {
      logData.innerHTML = `<tr><td colspan='7' class='no-data'>üöÄ No call logs for selected date</td></tr>`;
      return;
    }

    filtered.forEach((log) => {
      const row = document.createElement("tr");
      const phone = log.from?.startsWith("+") ? log.from : `+${log.from || 'Unknown'}`;

      const truncateText = (text, maxLength = 50) => {
        if (!text) return 'N/A';
        if (text.length <= maxLength) return text;
        return `<span class="truncated" title="${text}">${text.substring(0, maxLength)}...</span>`;
      };

      row.innerHTML = `
        <td><span class="phone-number">${phone}</span></td>
        <td class="name-cell">${log.name || 'N/A'}</td>
        <td class="email-cell">${truncateText(log.email, 25)}</td>
        <td class="age-cell">${log.age || 'N/A'}</td>
        <td class="location-cell">${truncateText(log.location, 20)}</td>
        <td class="introduction-cell">${truncateText(log.introduction, 60)}</td>
        <td class="timestamp">${formatDateTime(log.time) || 'Unknown'}</td>
      `;
      logData.appendChild(row);
    });
  }

  function makeTestCall() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Calling...';
    btn.disabled = true;

    fetch(BASE_URL + '/call-me')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          btn.innerHTML = '‚úÖ Call Initiated!';
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            setTimeout(loadLogs, 5000);
          }, 2000);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      })
      .catch(err => {
        console.error('Call failed:', err);
        btn.innerHTML = '‚ùå Call Failed';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 3000);
      });
  }

  function formatTimeAgo(timeString) {
    try {
      const time = new Date(timeString);
      const now = new Date();
      const diffMs = now - time;
      const diffMins = Math.floor(diffMs / 60000);
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
      return `${Math.floor(diffMins / 1440)}d ago`;
    } catch {
      return timeString;
    }
  }

  function formatDateTime(timeString) {
    try {
      const date = new Date(timeString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch {
      return timeString;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const datePicker = document.getElementById("datePicker");
    const today = new Date().toISOString().split("T")[0];
    datePicker.value = today;
    datePicker.max = today;
    loadLogs();
    refreshInterval = setInterval(loadLogs, 20000);
  });

  window.addEventListener("beforeunload", () => {
    if (refreshInterval) clearInterval(refreshInterval);
  });
</script>

</body>

</html>